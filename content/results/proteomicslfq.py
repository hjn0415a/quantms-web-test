from pathlib import Path
import streamlit as st
import pandas as pd

from src.common.common import page_setup

# Page setup
params = page_setup()
st.title("üìä Quantification Results")

# Path to results folder
results_dir = Path(st.session_state.workspace, "results")
proteomicslfq_dir = results_dir / "proteomicslfq"

# Check directory existence
if not proteomicslfq_dir.exists():
    st.warning("‚ùó 'proteomicslfq' directory not found. Please run the analysis first.")
    st.stop()

csv_files = sorted(proteomicslfq_dir.glob("*.csv"))

if not csv_files:
    st.info("No CSV files found in the 'proteomicslfq' directory.")
    st.stop()

# Select the first CSV file
csv_file = csv_files[0]

# Create tabs for Protein-level and PSM-level tables
protein_tab, psm_tab = st.tabs(["üß¨ Protein Table", "üìÑ PSM-level Quantification Table"])

try:
    df = pd.read_csv(csv_file)
    if df.empty:
        st.info("No data found in this file.")
        st.stop()

    # Raw tab
    with psm_tab:
        st.markdown(f"### üìÑ PSM-level Quantification Table")
        st.info("üí°INFO \n\n This table shows the PSM-level quantification data, including protein IDs,peptide sequences, charge states, and intensities across samples.Each row represents one peptide-spectrum match detected from the MS/MS analysis.")
        st.dataframe(df, use_container_width=True)

    # Protein tab
    with protein_tab:
        st.markdown("### üß¨ Protein-Level Abundance Table")
        st.info("üí°INFO \n\n"
        "This protein-level table is generated by grouping all PSMs that map to the "
        "same protein and aggregating their intensities across samples.\n"
        "It provides an overview of protein abundance rather than individual peptide measurements."
        )
        # Convert Reference ‚Üí Sample
        df['Sample'] = df['Reference'].str.replace('.mzML', '', regex=False)

        # Collect list of all samples
        all_samples = sorted(df['Sample'].unique())

        pivot_list = []

        # Aggregate PSMs to protein-level table
        for protein, group in df.groupby('ProteinName'):
            peptides = ";".join(group['PeptideSequence'].unique())
            intensity_dict = group.groupby('Sample')['Intensity'].sum().to_dict()
            intensity_dict_complete = {sample: intensity_dict.get(sample, 0) for sample in all_samples}

            row = {'ProteinName': protein, **intensity_dict_complete, 'PeptideSequence': peptides}
            pivot_list.append(row)

        pivot_df = pd.DataFrame(pivot_list)
        pivot_df = pivot_df[['ProteinName'] + all_samples + ['PeptideSequence']]

        st.dataframe(pivot_df, use_container_width=True)

except Exception as e:
    st.error(f"Failed to load {csv_file.name}: {e}")